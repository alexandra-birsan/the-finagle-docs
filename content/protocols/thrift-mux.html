

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Thrift &amp; Thrift Mux &mdash; The Finagle Docs 0.1-SNAPSHOT documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/css/theme_overrides.css" type="text/css" />
  

  
    <link rel="top" title="The Finagle Docs 0.1-SNAPSHOT documentation" href="../../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> The Finagle Docs
          

          
          </a>

          
            
            
              <div class="version">
                0.1-SNAPSHOT
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../finagle-util.html">Finagle Util</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="../service-discovery.html">Service Discovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contexts.html">Contexts</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">The Finagle Docs</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
    <li>Thrift &amp; Thrift Mux</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/content/protocols/thrift-mux.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="thrift-thrift-mux">
<h1>Thrift &amp; Thrift Mux<a class="headerlink" href="#thrift-thrift-mux" title="Permalink to this headline">¶</a></h1>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">This section is under construction.</p>
</div>
<div class="section" id="what-is-thrift">
<h2>What is Thrift<a class="headerlink" href="#what-is-thrift" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div>&#8220;Apache Thrift allows you to define data types and service interfaces in a simple definition file.
Taking that file as input, the compiler generates code to be used to easily build RPC clients and
servers that communicate seamlessly across programming languages. Instead of writing a load of
boilerplate code to serialize and transport your objects and invoke remote methods, you can get
right down to business.&#8221; - <a class="reference external" href="https://thrift.apache.org/">Apache Thrift</a></div></blockquote>
<p>Finagle provides its own code generator <a class="reference external" href="https://scrooge">Scrooge</a> to generate Thrift encoders and decoders, but also
the necessary finagle boilerplate create server and clients. The <a class="reference internal" href="#scrooge-code-generator">Scrooge Code Generator</a> section
describes the setup in more detail.</p>
</div>
<div class="section" id="thrift-vs-thriftmux">
<h2>Thrift vs ThriftMux<a class="headerlink" href="#thrift-vs-thriftmux" title="Permalink to this headline">¶</a></h2>
<p>Finagle provides two thrift protocol implementations. A standard <code class="docutils literal"><span class="pre">Thrift</span></code> protocol that is
compatible with other Thrift server and clients. And an improved <code class="docutils literal"><span class="pre">ThriftMux</span></code> implementation
that allows multiplexing one single connections.</p>
<p>If you have a heterogeneous environment the standard <code class="docutils literal"><span class="pre">Thrift</span></code> protocol should be used. For
pure finagle environments the <code class="docutils literal"><span class="pre">ThriftMux</span></code> protocol is recommended as it provides better
performance while using less resources.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The list of differences is not complete.</p>
</div>
</div>
<div class="section" id="distribute-thrift-definitions">
<h2>Distribute Thrift Definitions<a class="headerlink" href="#distribute-thrift-definitions" title="Permalink to this headline">¶</a></h2>
<p>A major benefit when using thrift is that you don&#8217;t have to distribute binaries ( class files or actual code ),
but language agnostic thrift files. How you distribute these files depends on your service structure,
build process and infrastructure.</p>
<p>At gutefrage every service contains two sbt submodules:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">server</span></code> - the actual implementation of the service</li>
<li><code class="docutils literal"><span class="pre">api</span></code> - a package containing the thrift files and the service name</li>
</ul>
<p>Depending on a service means depending on the <code class="docutils literal"><span class="pre">api</span></code> package. Each service generates the necessary
code with Scrooge to instantiate service clients. The next section describes the Scrooge setup.</p>
</div>
<div class="section" id="scrooge-code-generator">
<h2>Scrooge Code Generator<a class="headerlink" href="#scrooge-code-generator" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://scrooge">Scrooge</a> generates the necessary services stubs and finagle boilerplate to implement and
serve thrift services. Activate it by adding this to your <code class="docutils literal"><span class="pre">plugins.sbt</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">resolvers</span> <span class="o">+=</span> <span class="s">&quot;twitter-repo&quot;</span> <span class="n">at</span> <span class="s">&quot;https://maven.twttr.com&quot;</span>

<span class="n">addSbtPlugin</span><span class="o">(</span><span class="s">&quot;com.twitter&quot;</span> <span class="o">%%</span> <span class="s">&quot;scrooge-sbt-plugin&quot;</span> <span class="o">%</span> <span class="s">&quot;4.9.0&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>Put your thrift files in <code class="docutils literal"><span class="pre">src/main/thrift</span></code>. The thrift sbt-plugin will pick the up and
generate the code when you run <code class="docutils literal"><span class="pre">sbt</span> <span class="pre">compile</span></code>.</p>
<div class="section" id="include-thrift-files">
<h3>Include Thrift Files<a class="headerlink" href="#include-thrift-files" title="Permalink to this headline">¶</a></h3>
<p>Scrooge can extract <code class="docutils literal"><span class="pre">thrift</span></code> files from dependencies when added to the <code class="docutils literal"><span class="pre">scroogeThriftDependencies</span></code>
setting. This autoplugin adds <code class="docutils literal"><span class="pre">thrift</span></code> files to the created jar.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * This plugin adds the thrift files to the packaged jar.</span>
<span class="cm"> */</span>
<span class="k">object</span> <span class="nc">ApiThriftSourcesPlugin</span> <span class="k">extends</span> <span class="nc">AutoPlugin</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="k">requires</span> <span class="k">=</span> <span class="nc">GFApiPlugin</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">trigger</span> <span class="k">=</span> <span class="nc">AllRequirements</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">projectSettings</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Setting</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
    <span class="c1">// add thrift files to output jar</span>
    <span class="n">mappings</span> <span class="n">in</span> <span class="o">(</span><span class="nc">Compile</span><span class="o">,</span> <span class="n">packageBin</span><span class="o">)</span> <span class="o">++=</span> <span class="o">{</span>
      <span class="o">(</span><span class="n">sourceDirectory</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="s">&quot;main&quot;</span> <span class="o">/</span> <span class="s">&quot;thrift&quot;</span><span class="o">).</span><span class="n">listFiles</span><span class="o">()</span>
        <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">f</span> <span class="k">=&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">getName</span> <span class="n">endsWith</span> <span class="s">&quot;.thrift&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">file</span> <span class="k">=&gt;</span>
          <span class="n">file</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="s">s&quot;com/yourcompany/server/&lt;servicename&gt;/thrift/</span><span class="si">${</span><span class="n">file</span><span class="o">.</span><span class="n">getName</span><span class="si">}</span><span class="s">&quot;</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="o">.</span><span class="n">toSeq</span>
    <span class="o">}</span>
  <span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="add-thrift-dependencies-automatically">
<h3>Add Thrift Dependencies automatically<a class="headerlink" href="#add-thrift-dependencies-automatically" title="Permalink to this headline">¶</a></h3>
<p>This auto plugin provides a basic way to add <code class="docutils literal"><span class="pre">libraryDependencies</span></code> coming from a certain
organization to the <code class="docutils literal"><span class="pre">scroogeThriftDependencies</span></code>. Scrooge will then extract the <code class="docutils literal"><span class="pre">thrift</span></code>
files from these dependencies and process them.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">sbt._</span>
<span class="k">import</span> <span class="nn">com.twitter.scrooge.ScroogeSBT</span>

<span class="k">object</span> <span class="nc">AddThriftDependencies</span> <span class="k">extends</span> <span class="nc">AutoPlugin</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="k">requires</span> <span class="k">=</span> <span class="nc">ScroogeSBT</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">trigger</span> <span class="k">=</span> <span class="nc">AllRequirements</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">projectSettings</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
    <span class="c1">// add library dependencies to scrooge</span>
    <span class="n">scroogeThriftDependencies</span> <span class="n">in</span> <span class="nc">Compile</span> <span class="o">:=</span> <span class="o">{</span>
      <span class="c1">// splits (2.10)(.x)</span>
      <span class="k">val</span> <span class="n">pattern</span> <span class="k">=</span> <span class="s">&quot;(\\d*\\.{1}\\d*)(.*)&quot;</span><span class="o">.</span><span class="n">r</span>
      <span class="k">val</span> <span class="n">pattern</span><span class="o">(</span><span class="n">version</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=</span> <span class="n">scalaVersion</span><span class="o">.</span><span class="n">value</span>

      <span class="c1">// adds all services in library dependencies as thrift dependencies</span>
      <span class="n">libraryDependencies</span><span class="o">.</span><span class="n">value</span>
        <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">organization</span> <span class="n">startsWith</span> <span class="s">&quot;com.yourcompany.service&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">version</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="finagle-service">
<h2>Finagle Service<a class="headerlink" href="#finagle-service" title="Permalink to this headline">¶</a></h2>
<p>This section explains how to implement and start a thrift server and how to create a thrift client.
An <code class="docutils literal"><span class="pre">EchoService</span></code> will be used as an example. It&#8217;s defined by the following thrift definition file:</p>
<div class="highlight-thrift"><div class="highlight"><pre><span></span><span class="kn">namespace</span><span class="w"> </span><span class="nn">*</span><span class="w"> </span><span class="n">echo.thrift</span><span class="w"></span>

<span class="kd">service</span><span class="w"> </span><span class="nc">EchoService</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kt">string</span><span class="w"> </span><span class="nf">echo</span><span class="o">(</span><span class="kt">string</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="server">
<h3>Server<a class="headerlink" href="#server" title="Permalink to this headline">¶</a></h3>
<p>Scrooge generates different service stubs we could implement. A generic <code class="docutils literal"><span class="pre">EchoService[+MM[_]]</span></code> trait, that lets
the user define monadic container for the service. And a specialized variant <code class="docutils literal"><span class="pre">EchoService.FutureIface</span></code>, which uses
<em>Twitter Futures</em> as monadic containers. We recommend using the specialized variant as other helper classes require it.</p>
<p>A example implementation looks like this:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">echo.thrift._</span>
<span class="k">import</span> <span class="nn">com.twitter.util.Future</span>

<span class="k">val</span> <span class="n">service</span><span class="k">:</span> <span class="kt">EchoService.FutureIface</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EchoService</span><span class="o">.</span><span class="nc">FutureIface</span> <span class="o">{</span>
   <span class="k">override</span> <span class="k">def</span> <span class="n">echo</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Future</span><span class="o">.</span><span class="n">value</span><span class="o">(</span><span class="s">s&quot;Echo: </span><span class="si">$msg</span><span class="s">&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Next we need to wrap the <code class="docutils literal"><span class="pre">FutureIface</span></code> implementation into a <a class="reference external" href="https://twitter.github.io/finagle/docs/#com.twitter.finagle.Service">Finagle Service</a>. Scrooge generates an
<code class="docutils literal"><span class="pre">EchoService.FinagledService</span></code> for this purpose.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.twitter.finagle.Service</span>
<span class="k">import</span> <span class="nn">com.twitter.finagle.thrift.Protocols</span>

<span class="k">val</span> <span class="n">finagledService</span><span class="k">:</span> <span class="kt">Service</span><span class="o">[</span><span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]</span>, <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]]</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">EchoService</span><span class="o">.</span><span class="nc">FinagledService</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="nc">Protocols</span><span class="o">.</span><span class="n">binaryFactory</span><span class="o">())</span>
</pre></div>
</div>
<p>Now we can start a server.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com.twitter.finagle.</span><span class="o">{</span><span class="nc">Thrift</span><span class="o">,</span> <span class="nc">ThriftMux</span><span class="o">}</span>

<span class="c1">// thrift protocol without announcing</span>
<span class="k">val</span> <span class="n">thriftServer</span> <span class="k">=</span> <span class="nc">Thrift</span><span class="o">.</span><span class="n">server</span>
  <span class="o">.</span><span class="n">withLabel</span><span class="o">(</span><span class="s">&quot;thrift-echo-service&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">serve</span><span class="o">(</span>
    <span class="n">addr</span> <span class="k">=</span> <span class="s">&quot;:8080&quot;</span><span class="o">,</span>
    <span class="n">service</span> <span class="k">=</span> <span class="n">finagledService</span>
  <span class="o">)</span>

<span class="c1">// ThriftMux protocol with announcing to a local zk instance</span>
<span class="k">val</span> <span class="n">thriftMuxServer</span> <span class="k">=</span> <span class="nc">ThriftMux</span><span class="o">.</span><span class="n">server</span>
  <span class="o">.</span><span class="n">withLabel</span><span class="o">(</span><span class="s">&quot;thriftmux-echo-service&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">serveAndAnnounce</span><span class="o">(</span>
    <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;zk!127.0.0.1:2181!/service/echo!0&quot;</span><span class="o">,</span>
    <span class="n">addr</span> <span class="k">=</span> <span class="s">&quot;:8081&quot;</span><span class="o">,</span>
    <span class="n">service</span> <span class="k">=</span> <span class="n">finagledService</span>
  <span class="o">)</span>
</pre></div>
</div>
<p>For more information on serving, announcing and resolving read the <a class="reference internal" href="../service-discovery.html#service-discovery"><span class="std std-ref">Service Discovery</span></a> section.</p>
</div>
<div class="section" id="client">
<h3>Client<a class="headerlink" href="#client" title="Permalink to this headline">¶</a></h3>
<p>Creating a client is done with the same <code class="docutils literal"><span class="pre">EchoService.FutureIface</span></code> trait.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">echo.thrift._</span>
<span class="k">import</span> <span class="nn">com.twitter.finagle.</span><span class="o">{</span><span class="nc">Thrift</span><span class="o">,</span> <span class="nc">ThriftMux</span><span class="o">}</span>

<span class="c1">// Thrift client with dtab resolving</span>
<span class="k">val</span> <span class="n">thriftClient</span> <span class="k">=</span> <span class="nc">Thrift</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">newIface</span><span class="o">[</span><span class="kt">EchoService.FutureIFace</span><span class="o">](</span>
  <span class="n">dest</span> <span class="k">=</span> <span class="s">&quot;/s/echo&quot;</span><span class="o">,</span> <span class="n">label</span> <span class="k">=</span> <span class="s">&quot;echo-service-client&quot;</span>
<span class="o">)</span>

<span class="c1">// ThriftMux client with static inet resolving</span>
<span class="k">val</span> <span class="n">thriftMuxClient</span> <span class="k">=</span> <span class="nc">ThriftMux</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">newIface</span><span class="o">[</span><span class="kt">EchoService.FutureIface</span><span class="o">](</span>
  <span class="n">dest</span> <span class="k">=</span> <span class="s">&quot;echo.services.local:8080&quot;</span><span class="o">,</span> <span class="n">label</span> <span class="k">=</span> <span class="s">&quot;echo-service-mux-client&quot;</span>
<span class="o">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">dest</span></code> parameter value depends on the type of <a class="reference internal" href="../service-discovery.html#service-discovery"><span class="std std-ref">Service Discovery</span></a> in use.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Gutefrage.net.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1-SNAPSHOT',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>